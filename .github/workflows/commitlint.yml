# Use commitlint to ensure commit messages follow the Conventional Commits specification.
#
# References:
# - commitlint: https://commitlint.js.org
# - Conventional Commits: https://www.conventionalcommits.org
name: â™» commitlint

on:
  workflow_call:
    inputs:
      runs_on:
        description: The label of the runner (GitHub- or self-hosted) to run this workflow on. Defaults to `ubuntu-24.04`.
        type: string
        required: false
        default: ubuntu-24.04

      node_version:
        description: The version of Node.js to install.
        type: string
        required: false
        default: latest

      commitlint_version:
        description: The version of commitlint to install.
        type: string
        required: false
        default: latest

      extends:
        description: A JSON array of shareable configurations to install. Additional configuration can be set in a file `.commitlintrc` (https://commitlint.js.org/reference/configuration.html).
        type: string
        required: false
        default: '["@commitlint/config-conventional"]'

      message:
        description: A commit message to lint. Defaults to last commit message.
        type: string
        required: false

      help_url:
        description: Custom help URL for error messages.
        type: string
        required: false

permissions: {}

jobs:
  commitlint:
    name: commitlint
    runs-on: ${{ inputs.runs_on }}
    permissions:
      contents: read # Required to checkout the repository
    env:
      COMMITLINT_VERSION: ${{ inputs.commitlint_version }}
      EXTENDS_JSON: ${{ inputs.extends }}
      MESSAGE: ${{ inputs.message }}
      BASE_SHA: ${{ github.event.pull_request.base.sha }}
      HEAD_SHA: ${{ github.event.pull_request.head.sha }}
      HELP_URL: ${{ inputs.help_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          # Required to lint a commit range using the --from and --to parameters
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ inputs.node_version }}

      - name: Install dependencies
        run: |
          readarray -t extends <<< "$(echo "$EXTENDS_JSON" | jq -cr '.[]')"
          npm install "${extends[@]}"

      - name: Run commitlint
        run: |
          readarray -t extends <<< "$(echo "$EXTENDS_JSON" | jq -cr '.[]')"

          optional_args=()

          if [[ -n "$MESSAGE" ]]; then
            echo "Linting commit message from stdin" >&2
          elif [[ -n "$BASE_SHA" && -n "$HEAD_SHA" ]]; then
            echo "Linting commit range" >&2
            optional_args+=(--from "$BASE_SHA" --to "$HEAD_SHA")
          else
            echo "Linting last commit" >&2
            optional_args+=(--last)
          fi

          npx "commitlint@$COMMITLINT_VERSION" --extends "${extends[@]}" --help-url "$HELP_URL" --verbose "${optional_args[@]}" <<< "$MESSAGE"
