# Use commitlint to ensure commit messages follow the Conventional Commits specification.
#
# References:
# - commitlint: https://commitlint.js.org
# - Conventional Commits: https://www.conventionalcommits.org
name: â™» commitlint

on:
  workflow_call:
    inputs:
      runs_on:
        description: The label of the runner (GitHub- or self-hosted) to run this workflow on. Defaults to `ubuntu-24.04`.
        type: string
        required: false
        default: ubuntu-24.04

      node_version:
        description: The version of Node.js to install.
        type: string
        required: false
        default: latest

      commitlint_version:
        description: The version of commitlint to install.
        type: string
        required: false
        default: latest

      extends:
        description: A JSON array of shareable configurations to install. Additional configuration can be set in a file `.commitlintrc` (https://commitlint.js.org/reference/configuration.html).
        type: string
        required: false
        default: '["@commitlint/config-conventional"]'

      message:
        description: A commit message to lint. Defaults to last commit message.
        type: string
        required: false

      help_url:
        description: Custom help URL for error messages.
        type: string
        required: false

permissions: {}

jobs:
  commitlint:
    name: commitlint
    runs-on: ${{ inputs.runs_on }}
    permissions:
      contents: read # Required to checkout the repository
    env:
      COMMITLINT_VERSION: ${{ inputs.commitlint_version }}
      EXTENDS_JSON: ${{ inputs.extends }}
      MESSAGE: ${{ inputs.message }}
      HELP_URL: ${{ inputs.help_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version: ${{ inputs.node_version }}

      - name: Install dependencies
        run: |
          readarray -t extends <<< "$(echo "$EXTENDS_JSON" | jq -cr '.[]')"
          npm install "${extends[@]}"

      - name: Run commitlint
        run: |
          readarray -t extends <<< "$(echo "$EXTENDS_JSON" | jq -cr '.[]')"
          optional_args=()
          if [[ -z "$MESSAGE" ]]; then
            optional_args+=(--last)
          fi
          npx "commitlint@$COMMITLINT_VERSION" --extends "${extends[@]}" --help-url "$HELP_URL" "${optional_args[@]}" --verbose <<< "$MESSAGE"
